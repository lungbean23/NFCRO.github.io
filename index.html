<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>NFC Modular Sampler Rack</title>
</head>
<body>
    <h1>NFC Modular Sampler Rack</h1>

    <label for="sampleSelect">Select Sample:</label>
    <select id="sampleSelect">
        <option value="https://cdn.freesound.org/previews/414/414209_5121236-lq.mp3">Ambient Loop</option>
        <option value="https://cdn.freesound.org/previews/250/250629_4486188-lq.mp3">Drum Loop</option>
    </select>
    <br><br>

    <button id="startButton">Start Audio Context</button>
    <button id="playButton">Play Sample</button>
    <button id="scanNFCButton">Scan NFC</button>

    <pre id="status">Status: Idle</pre>

    <script src="https://unpkg.com/tone@next/build/Tone.js"></script>
    <script>
let player;
let effectChain = [];
let effectMap = {}; // ADD THIS LINE

document.getElementById("startButton").addEventListener("click", async () => {
    await Tone.start();
    log("Tone.js AudioContext started.");
});

document.getElementById("playButton").addEventListener("click", async () => {
    const selectedSample = document.getElementById("sampleSelect").value;
    if (player) {
        player.stop();
        player.dispose();
    }

    player = new Tone.Player({
        url: selectedSample,
        autostart: true
    });

    let lastNode = player;
    for (let effect of effectChain) {
        lastNode.connect(effect);
        lastNode = effect;
    }
    lastNode.connect(Tone.Destination);

    log(`Playing sample: ${selectedSample}`);
});

document.getElementById("scanNFCButton").addEventListener("click", async () => {
    if ("NDEFReader" in window) {
        try {
            const reader = new NDEFReader();
            await reader.scan();
            log("NFC scan started. Tap a tag...");

            reader.onreading = event => {
                const decoder = new TextDecoder();
                for (const record of event.message.records) {
                    const data = decoder.decode(record.data);
                    log(`NFC Tag Read: ${data}`);
                    try {
                        const json = JSON.parse(data);
                        handleModule(json);
                    } catch (e) {
                        log(`Error parsing JSON: ${e}. Passing through without change.`);
                    }
                }
            };

        } catch (error) {
            log(`NFC scan failed: ${error}`);
        }
    } else {
        log("Web NFC not supported in this browser.");
    }
});

function handleModule(json) {
    if (!json || typeof json !== "object") {
        log("No valid JSON data on NFC tag, passing through without change.");
        return;
    }

    if (json.action === "add") {
        const moduleName = json.module;
        if (!moduleName) {
            log("No module specified in JSON, passing through.");
            return;
        }

        if (effectMap[moduleName]) {
            // Module already exists, remove it (toggle OFF)
            const effect = effectMap[moduleName];
            effect.dispose();
            delete effectMap[moduleName];
            effectChain = effectChain.filter(e => e !== effect);
            log(`${moduleName} removed (toggle OFF).`);
        } else {
            // Module does not exist, add it (toggle ON)
            let effect;
            if (moduleName === "reverb") {
                effect = new Tone.Reverb(json.decay || 1.5).toDestination();
                effect.wet.value = json.wet || 0.5;
                log(`Reverb added: decay=${json.decay || 1.5}, wet=${json.wet || 0.5}`);
            }
            else if (moduleName === "filter") {
                effect = new Tone.Filter(json.frequency || 800, json.type || "lowpass").toDestination();
                log(`Filter added: freq=${json.frequency || 800}, type=${json.type || "lowpass"}`);
            }
            else if (moduleName === "delay") {
                effect = new Tone.FeedbackDelay(json.delayTime || "8n", json.feedback || 0.5).toDestination();
                log(`Delay added: delayTime=${json.delayTime || "8n"}, feedback=${json.feedback || 0.5}`);
            }
            else if (moduleName === "distortion") {
                effect = new Tone.Distortion(json.amount || 0.4).toDestination();
                log(`Distortion added: amount=${json.amount || 0.4}`);
            }
            else {
                log(`Unknown module: ${moduleName}. Passing through without change.`);
                return;
            }
            effectMap[moduleName] = effect;
            effectChain.push(effect);
        }
    }
    else if (json.action === "clear") {
        effectChain.forEach(effect => effect.dispose());
        effectChain = [];
        effectMap = {};
        log("Effect chain cleared.");
    }
    else {
        log(`Unknown or missing action: ${json.action}. Passing through without change.`);
    }
}

function log(msg) {
    const status = document.getElementById("status");
    status.textContent += `\n${msg}`;
    status.scrollTop = status.scrollHeight;
}
    </script>
</body>
</html>
